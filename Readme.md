# NIR — анализ кредитного скоринга и справедливости (HMDA 2017 CA)

Этот репозиторий содержит код и инфраструктуру для базового эксперимента с моделью кредитного скоринга на данных **HMDA 2017 (штат Калифорния)**, а также набор запусков для оценки и улучшения справедливости модели.

## Содержание

- [Требования](#требования)
- [Быстрый старт](#быстрый-старт)
- [Структура проекта](#структура-проекта)
- [Данные](#данные)
- [Запуски](#запуски)
- [Полезные переменные и параметры](#полезные-переменные-и-параметры)
- [Типичные проблемы и решения](#типичные-проблемы-и-решения)
- [Лицензия и источники данных](#лицензия-и-источники-данных)

---

## Требования

- Python 3.9+  
- `pip` (или `pipx`)  
- ОС: Linux / macOS / Windows

Файл зависимостей: `requirements.txt`  
(основные библиотеки: `pandas`, `numpy`, `scikit-learn`, `xgboost`, `shap`, `fairlearn`, `matplotlib`, `seaborn`).

---

## Быстрый старт

1. Установка библиотек:
   ```bash
   make libs
   ```

2. Загрузка и распаковка данных HMDA в папку `data/`:
   ```bash
   make install
   ```
   Под капотом вызывается `install.py`, который скачивает архив **HMDA 2017 CA** и распаковывает его в `./data`.  
   URL можно переопределить:
   ```bash
   make install URL=https://example.com/custom.zip
   ```

3. Предварительная фильтрация/подготовка датасета:
   ```bash
   make filter
   ```

4. Запуск базового пайплайна:
   ```bash
   make runbase
   ```

5. Запуски экспериментов по справедливости:
   ```bash
   make runfair
   make runfairall
   ```

---

## Структура проекта


```
NIR Project/
├── .gitignore                 
├── config.py                  # переменные окружения
├── corr.py                    # анализ корреляций признаков
├── data_loader.py             # загрузка очищенного датасета train/test split
├── features.py                # генерация фичей
├── filter.py                  # очистка датасета
├── install.py                 # скачивание и распаковка HMDA-архива в папку data/
├── Makefile                   # удобные команды для запуска
├── Readme.md                  # документация
├── requirements.txt           # список зависимостей
├── shapExp.py                 # интерпретация модели через shap
├── data/                      # каталог с данными 
├── NIR/                       # базовая модель без улучшения по метрикам честности
│   ├── main.py                # точка входа
│   ├── model.py               # конфигурации модели
│   └── evaluate.py            # оценка качества модели
├── NIR fairness improvement/  # модель с улучшениями по одной из метрик
│   ├── main.py                # точка входа
│   ├── debias.py              # техники снижения смещения по чувствительным признакам
│   ├── model.py               # конфигурации модели
│   └── evaluate.py            # оценка качества модели
└── NIR fairness improvement all together/   # модель с комплексным улучшениям по всем метрикам
    ├── main.py                # точка входа без оптимизации порогов
    ├── prg_main.py            # оптимизированная точка входа
    ├── tune_main.py           # точка входа для подбора гиперпараметров
    ├── tune_model.py          # подбор гиперпараметров
    ├── optimize_threshhold.py # оптимизация порогов для баланса качества и справедливости
    ├── debias.py              # техники снижения смещения по чувствительным признакам
    ├── model.py               # конфигурации модели
    └── evaluate.py            # оценка качества модели


```

---

## Данные

- Источник: CFPB HMDA Historic Loan Data — **2017, California**.  
- Скачивается архив `hmda_2017_ca_all-records_labels.zip`.  
- Скрипт `install.py`:
  - надёжно скачивает файл (через `urllib.request`) во временный `.part`,
  - перемещает в `data/`,
  - распаковывает через стандартный модуль `zipfile`,
  - кладёт метку `.hmda_2017_ca_unpacked.stamp`.

---

## Запуски

Цели `Makefile`:

- `make libs` — установка зависимостей из `requirements.txt`.
- `make install` — загрузка и распаковка HMDA в `./data`.
- `make filter` — запуск `filter.py`.
- `make runbase` — запуск `NIR/main.py`.
- `make runfair` — запуск `NIR/fairness_improvement/main.py`.
- `make runfairall` — запуск `NIR/fairness_improvement_all_together/prg_main.py`.

Передача аргументов:
```bash
make runbase ARGS="--seed 42 --max-depth 6"
```

